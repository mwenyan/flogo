"use strict";var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}(),__decorate=this&&this.__decorate||function(e,t,r,i){var n,o=arguments.length,s=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,i);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(s=(o<3?n(s):o>3?n(t,r,s):n(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0});var Observable_1=require("rxjs/Observable"),core_1=require("@angular/core"),http_1=require("@angular/http"),wi_contrib_1=require("wi-studio/app/contrib/wi-contrib"),QueryDocumentActivityContributionHandler=function(e){function t(t,r){var i=e.call(this,t,r)||this;return i.injector=t,i.http=r,i.value=function(e,t){var r=t.getField("query").value,n=t.getField("queryParams").value;switch(e){case"connector":var o=[];return Observable_1.Observable.create(function(e){wi_contrib_1.WiContributionUtils.getConnections(i.http,"AzureCosmosDB","CosmosDBConnector").subscribe(function(t){t.forEach(function(e){if(e.isValid)for(var t=0;t<e.settings.length;t++)if("name"===e.settings[t].name){o.push({unique_id:wi_contrib_1.WiContributionUtils.getUniqueId(e),name:e.settings[t].value});break}}),e.next(o)})});case"input":var s={$schema:"http://json-schema.org/draft-04/schema#",type:"object",properties:{database:{type:"string"},collection:{type:"string"},"x-ms-activity-id":{type:"string"},"x-ms-max-item-count":{type:"integer"},"x-ms-continuation":{type:"string"},"x-ms-consistency-level":{type:"string"},"x-ms-session-token":{type:"string"}},required:["database","collection"]};if(Boolean(r)&&Boolean(n)&&n.value){var a=JSON.parse(n.value);s.properties.parameters={type:"object",properties:{}};for(var c=0;c<a.length;c++){var p=a[c].parameterName,u=a[c].type,l=a[c].repeating;s.properties.parameters.properties[p]=l?{type:"array",items:{type:u}}:{type:u}}s.required=["database","collection","parameters"]}return JSON.stringify(s);case"output":var y={code:"",message:"","x-ms-activity-id":"","x-ms-session-token":"","x-ms-continuation":"",_rid:"",Documents:[],_count:0},_={$schema:"http://json-schema.org/draft-04/schema#",type:"object",properties:{code:{type:"string"},message:{type:"string"},"x-ms-activity-id":{type:"string"},"x-ms-session-token":{type:"string"},"x-ms-continuation":{type:"string"},_rid:{type:"string"},Documents:{type:"array",items:{type:"object",properties:{}}},_count:{type:"integer"}}},m=t.getField("document").value;if(Boolean(m)){var f=JSON.parse(m);return Boolean(f.$schema)?(f.properties.id={type:"string"},f.properties._rid={type:"string"},f.properties._self={type:"string"},f.properties._etag={type:"string"},f.properties._attachments={type:"string"},f.properties._ts={type:"integer"},_.properties.Documents.items.properties=f.properties,JSON.stringify(_)):(f.id="",f._rid="",f._self="",f._etag="",f._attachments="",f._ts=0,y.Documents.push(f),JSON.stringify(y))}return null}return null},i.validate=function(e,t){return null},i}return __extends(t,e),t=__decorate([wi_contrib_1.WiContrib({}),core_1.Injectable(),__metadata("design:paramtypes",[core_1.Injector,http_1.Http])],t)}(wi_contrib_1.WiServiceHandlerContribution);exports.QueryDocumentActivityContributionHandler=QueryDocumentActivityContributionHandler;