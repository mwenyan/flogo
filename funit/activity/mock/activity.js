"use strict";var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function o(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(o.prototype=r.prototype,new o)}}(),__decorate=this&&this.__decorate||function(e,t,r,o){var n,i=arguments.length,l=i<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)l=Reflect.decorate(e,t,r,o);else for(var c=e.length-1;c>=0;c--)(n=e[c])&&(l=(i<3?n(l):i>3?n(t,r,l):n(t,r))||l);return i>3&&l&&Object.defineProperty(t,r,l),l},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0});var Observable_1=require("rxjs/Observable"),core_1=require("@angular/core"),http_1=require("@angular/http"),wi_contrib_1=require("wi-studio/app/contrib/wi-contrib"),MockActivityContributionHandler=function(e){function t(t,r,o){var n=e.call(this,t,r,o)||this;return n.injector=t,n.http=r,n.contribModelService=o,n.value=function(e,t){var r=n.getModelService().getApplication(),o=t.getField("flowURI").value;if("flowURI"===e){var i=[],l=[];if(r){(c=r.getTriggerFlowModelMaps()).map(function(e){t.getCurrentFlowName()===e.getFlowModel().getName()||e.getFlowModel().isTriggerFlow()||-1===i.indexOf(e.getFlowModel().getName())&&(i.push(e.getFlowModel().getName()),l.push({unique_id:"res://flow:"+e.getFlowModel().getName().replace(/ /g,"_"),name:e.getFlowModel().getName()}))})}return l}if("input"===e){if(r&&o){for(var c=r.getTriggerFlowModelMaps(),a=null,u=0;u<c.length;u++){if(o==="res://flow:"+(f=c[u]).getFlowModel().getName().replace(/ /g,"_")){a=f.getFlowModel().getFlowInputSchema().json;break}}return a}}else if("output"===e&&r&&o){for(c=r.getTriggerFlowModelMaps(),a=null,u=0;u<c.length;u++){var f;if(o==="res://flow:"+(f=c[u]).getFlowModel().getName().replace(/ /g,"_")){a=f.getFlowModel().getFlowOutputSchema().json;break}}return a}return null},n.validate=function(e,t){var r=n.getModelService().getApplication(),o=t.getField("flowURI").value;if("flowURI"===e&&o){var i=[],l={};if(r){return r.getTriggerFlowModelMaps().map(function(e){if(!e.getFlowModel().isTriggerFlow()){var t="res://flow:"+e.getFlowModel().getName().replace(/ /g,"_");-1===i.indexOf(t)&&(i.push(t),l[t]=e.getFlowModel())}}),Observable_1.Observable.create(function(e){var t=wi_contrib_1.ValidationResult.newValidationResult();n.isLoopDetected(o,o,l)&&t.setError("SUBFLOW-LOOP","Cyclic dependency detected in the subflow"),e.next(t)})}}return null},n.isLoopDetected=function(e,t,r){if(r&&r[t]){var o=r[t].getErrorFlow();if(this.checkLoopInFlow(e,t,r[t],r))return!0;if(o&&this.checkLoopInFlow(e,t,o,r))return!0}return!1},n.checkLoopInFlow=function(e,t,r,o){var n=r.getFlowElement();return!(!this.checkCurrentElement(n,e,o)&&!this.checkChildren(n,e,o))},n.checkChildren=function(e,t,r){for(var o=!1,n=0,i=e.getChildren();n<i.length;n++){var l=i[n];if(this.checkCurrentElement(l,t,r)){o=!0;break}o=this.checkChildren(l,t,r)}return o},n.checkCurrentElement=function(e,t,r){if("flogo-subflow"===e.name){var o=e.getField("flowURI").value;return o===t||this.isLoopDetected(t,o,r)}return!1},n}return __extends(t,e),t=__decorate([wi_contrib_1.WiContrib({}),core_1.Injectable(),__metadata("design:paramtypes",[core_1.Injector,http_1.Http,wi_contrib_1.WiContribModelService])],t)}(wi_contrib_1.WiServiceHandlerContribution);exports.MockActivityContributionHandler=MockActivityContributionHandler;