"use strict";var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),__decorate=this&&this.__decorate||function(e,t,n,o){var i,r=arguments.length,a=r<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,o);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(r<3?i(a):r>3?i(t,n,a):i(t,n))||a);return r>3&&a&&Object.defineProperty(t,n,a),a},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},__param=this&&this.__param||function(e,t){return function(n,o){t(n,o,e)}};Object.defineProperty(exports,"__esModule",{value:!0});var http_1=require("@angular/http"),core_1=require("@angular/core"),wi_contrib_1=require("wi-studio/app/contrib/wi-contrib"),contrib_1=require("wi-studio/common/models/contrib"),rxjs_extensions_1=require("wi-studio/common/rxjs-extensions");require("wi-studio/common/rxjs-extensions");var validation_1=require("wi-studio/common/models/validation");require("rxjs/add/observable/zip");var cryptos=require("crypto-js"),schemadoc_1=require("./schemadoc"),Result=function(e,t,n){},Connection=function(){function e(t){var n=this;this.http=t,this.connectionProps=function(){return rxjs_extensions_1.Observable.zip(rxjs_extensions_1.Observable.of(n.accountName),rxjs_extensions_1.Observable.of(n.expiryDate),rxjs_extensions_1.Observable.of(n.accessKey),rxjs_extensions_1.Observable.of(n.sasToken),function(e,t,n,o,i){return{accountName:e,connectionType:t,expiryDate:n,accessKey:o,sasToken:i}})},this.getSASCode=function(t){return e.getConnection(t.settings,n.http).switchMap(function(o){if(o.name&&o.name.trim().length>0&&o.accountName&&o.accountName.trim().length>0&&o.connectionType){var i="",r="";if("Generate SAS"===o.connectionType){if(o.expiryDate&&o.accessKey){var a="";if(a=a+o.accountName+"\nrwdlacup\nbfqt\nsco\n",a=null!==o.expiryDate&&o.expiryDate.trim().length>0?a+"\n"+o.expiryDate:"expDateErrorMsg",a+="\n",a+="\nhttps\n2017-11-09\n",!e.dateRegx.test(o.expiryDate))throw new Error("Please enter date in UTC format YYYY-MM-DDThh:mm:ssZ.");var s,c=void 0,u=o.accessKey,l=cryptos.enc.Base64.parse(u);s=cryptos.HmacSHA256(a,l),c=cryptos.enc.Base64.stringify(s),c=encodeURIComponent(c),i="sv=2017-11-09&ss=bfqt&srt=sco&sp=rwdlacup&se="+o.expiryDate+"&spr=https&sig="+c,r="https://"+o.accountName+".file.core.windows.net/?comp=list&"+i}}else if("Enter SAS"===o.connectionType&&o.sas){var _=(i=o.sas.substring(1,o.sas.length)).split("ss=")[1];if(!_)throw new Error("Invalid SAS token.");switch(_.split("&")[0].charAt(0)){case"f":r="https://"+o.accountName+".file.core.windows.net/?comp=list&"+i;break;case"t":r="https://"+o.accountName+".table.core.windows.net/Tables/?"+i;break;case"b":r="https://"+o.accountName+".blob.core.windows.net/?comp=list&"+i;break;case"q":r="https://"+o.accountName+".queue.core.windows.net/?comp=list&"+i;break;default:throw new Error("Invalid SAS token.")}}if(""===r)throw new Error("Please Enter Mandatory Field.");return wi_contrib_1.WiProxyCORSUtils.createRequest(n.http,r).addHeader("Accept","application/json").addMethod("GET").send().switchMap(function(e){if(e.ok){for(var n=0;n<t.settings.length;n++)"WI_STUDIO_OAUTH_CONNECTOR_INFO"===t.settings[n].name?"Generate SAS"===o.connectionType?t.settings[n].value='{"account_name":"'+o.accountName+'","access_key":"'+o.accessKey+'","expiry_date":"'+o.expiryDate+'","conn_type":"'+o.connectionType+'","sas_token":"?'+i+'"}':"Enter SAS"===o.connectionType&&(t.settings[n].value='{"account_name":"'+o.accountName+'","sas_token":"'+o.sas+'","conn_type":"'+o.connectionType+'"}'):"DocsMetadata"===t.settings[n].name&&(t.settings[n].value=schemadoc_1.JsonSchema.Types.schemaDoc());var r={context:t,authType:wi_contrib_1.AUTHENTICATION_TYPE.BASIC,authData:{}};return rxjs_extensions_1.Observable.of(contrib_1.ActionResult.newActionResult().setResult(r))}throw new Error("AuthenticationFailed, Make sure the value of Connection parammeters are correct.")}).catch(function(e){throw console.log("AuthenticationFailed: "+e),new Error("AuthenticationFailed, Make sure the value of Connection parameters are correct.")})}throw new Error("Please Enter Mandatory Field.")})},this.authorizationNeeded=function(){var e=n.WI_STUDIO_OAUTH_CONNECTOR_INFO&&""!==n.WI_STUDIO_OAUTH_CONNECTOR_INFO?JSON.parse(n.WI_STUDIO_OAUTH_CONNECTOR_INFO):{},t=!0;return"Generate SAS"===n.connectionType?t=!e.sas_token||n.accountName!==e.account_name||n.accessKey!==e.access_key||n.expiryDate!==e.expiry_date:"Enter SAS"===n.connectionType&&(t=!e.sas_token||n.accountName!==e.account_name||n.sas!==e.sas_token),console.log("Authorization is required: "+t),t}}return e.getConnection=function(t,n){var o=new e(n);return rxjs_extensions_1.Observable.from(t).reduce(function(e,t){return e[t.name]=t.value,e},o)},e}();Connection.dateRegx=/^\d{4}-(?:0[1-9]|1[0-2])-(?:0[1-9]|[1-2]\d|3[0-1])T(?:[0-1]\d|2[0-3]):[0-5]\d:[0-5]\dZ/,exports.Connection=Connection;var TibcoAzureStorageConnectorContribution=function(e){function t(t,n){var o=e.call(this,t,n)||this;return o.http=n,o.NO_CHANGE=null,o.value=function(e,t){return o.validations[t.title]&&o.validations[t.title][e]&&delete o.validations[t.title][e],o.validations[t.title]||(o.validations[t.title]={}),null},o.validate=function(e,t){for(var n,o=0;o<t.settings.length;o++)if("connectionType"===t.settings[o].name){n=t.settings[o].value;break}return"expiryDate"===e||"accessKey"===e?"Generate SAS"===n?validation_1.ValidationResult.newValidationResult().setVisible(!0):validation_1.ValidationResult.newValidationResult().setVisible(!1):"sas"===e?"Enter SAS"===n?validation_1.ValidationResult.newValidationResult().setVisible(!0):validation_1.ValidationResult.newValidationResult().setVisible(!1):null},o.connection=function(e){var t=new Connection(o.http);return rxjs_extensions_1.Observable.from(e).reduce(function(e,t){return e[t.name]=t.value,e},t)},o.isDuplicate=function(e,t){return wi_contrib_1.WiContributionUtils.getConnections(o.http,o.category).mergeMap(function(e){return e}).map(function(e){return{id:wi_contrib_1.WiContributionUtils.getUniqueId(e),ction:o.connection(e.settings)}}).filter(function(e){return e.id!==t}).mergeMap(function(e){return e.ction}).filter(function(t){return t.name===e.name}).reduce(function(e,t){return e.push(t),e},[]).map(function(e){return e.length>0})},o.defaultResult=function(e){var t={context:e,authType:wi_contrib_1.AUTHENTICATION_TYPE.BASIC,authData:{}};return rxjs_extensions_1.Observable.of(contrib_1.ActionResult.newActionResult().setResult(t))},o.action=function(e,t){if("Login"===e)return o.connection(t.settings).switchMap(function(e){return o.isDuplicate(e,wi_contrib_1.WiContributionUtils.getUniqueId(t)).map(function(t){if(t)throw new Error("Connection with name "+e.name+" already exists");return e})}).switchMap(function(e){return e.authorizationNeeded()?e.getSASCode(t):o.defaultResult(t)}).catch(function(e){return console.log("Connection validation: "+e),rxjs_extensions_1.Observable.of(contrib_1.ActionResult.newActionResult().setSuccess(!1).setResult(new validation_1.ValidationError("AZSTORAGE-1001","Connection validation: "+e)))})},o.validations={},o.category="Azurestorage",o}return __extends(t,e),t}(wi_contrib_1.WiServiceHandlerContribution);TibcoAzureStorageConnectorContribution=__decorate([wi_contrib_1.WiContrib({}),core_1.Injectable(),__param(0,core_1.Inject(core_1.Injector)),__metadata("design:paramtypes",[Object,http_1.Http])],TibcoAzureStorageConnectorContribution),exports.TibcoAzureStorageConnectorContribution=TibcoAzureStorageConnectorContribution;